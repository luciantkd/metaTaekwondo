const questionsByBelt = {
    "10th": [
        {
            question: "What is the meaning of Taekwondo?",
            options: ["The way of the hand and foot", "The art of fighting", "The way of peace", "The way of the warrior"],
            answer: "The way of the hand and foot"
        },
        {
            question: "How many belts are there in Taekwondo?",
            options: ["8", "10", "12", "14"],
            answer: "10"
        },
        {
            question: "Which country originated Taekwondo?",
            options: ["Japan", "China", "South-Korea", "Thailand"],
            answer: "South-Korea"
        },
        {
            question: "How do you say \"attention\" in Korean?",
            options: ["Charyeot", "Kyeongne", "Choonbi", "Shijak"],
            answer: "Charyeot"
        },
        {
            question: "What is the Korean term for \"bow\"?",
            options: ["Charyeot", "Kyeongne", "Joonbi", "Shijak"],
            answer: "Kyeongne"
        },
        {
            question: "In Korean, how do you say \"get ready\"?",
            options: ["Charyeot", "Kyeongne", "Choonbi", "Shijak"],
            answer: "Choonbi"
        },
        {
            question: "What is the Korean word for \"punch\"?",
            options: ["Jirugi", "Chagi", "Makki", "Kihap"],
            answer: "Jirugi"
        },
        {
            question: "How do you say \"block\" in Korean?",
            options: ["Jirugi", "Chagi", "Makki", "Seogi"],
            answer: "Makki"
        },
        {
            question: "What is the Korean term for \"kick\"?",
            options: ["Jirugi", "Chagi", "Makki", "Seogi"],
            answer: "Chagi"
        },
        {
            question: "How do you say \"thank you\" in Korean?",
            options: ["Annyeong", "Kamsahamnida", "Mianhamnida", "Juseyo"],
            answer: "Kamsahamnida"
        },
        {
            question: "What is the Korean word for \"shout\"?",
            options: ["Kihap", "Kyeongne", "Charyeot", "Joonbi"],
            answer: "Kihap"
        },
        {
            question: "How do you say \"training hall\" in Korean?",
            options: ["Dobok", "Dojang", "Kyorugi", "Poomsae"],
            answer: "Dojang"
        },
        {
            question: "What is the Korean term for \"training uniform\"?",
            options: ["Dobok", "Dojang", "Kyorugi", "Poomsae"],
            answer: "Dobok"
        },
        {
            question: "What is the Korean command for number 1?",
            options: ["Tul", "Hana", "Seyt", "Neyt"],
            answer: "Hana"
        },
        {
            question: "Which number corresponds to the Korean command \"Tul\"?",
            options: ["1", "2", "3", "4"],
            answer: "2"
        },
        {
            question: "What is the Korean command for number 2?",
            options: ["Set", "Dasut", "Dool", "Ilkop"],
            answer: "Dool"
        },
        {
            question: "Which number corresponds to the Korean command \"Set\"?",
            options: ["1", "2", "3", "4"],
            answer: "3"
        },
        {
            question: "What is the Korean command for number 3?",
            options: ["Net", "Set", "Yodul", "Ilkop"],
            answer: "Set"
        },
        {
            question: "Which number corresponds to the Korean command \"Net\"?",
            options: ["3", "4", "5", "6"],
            answer: "4"
        },
        {
            question: "What is the Korean command for number 4?",
            options: ["Dasut", "Set", "Net", "Ahop"],
            answer: "Net"
        },
        {
            question: "Which number corresponds to the Korean command \"Dasut\"?",
            options: ["4", "5", "6", "7"],
            answer: "5"
        },
        {
            question: "What is the Korean command for number 5?",
            options: ["Neyt", "Tassut", "Yassut", "Ilkop"],
            answer: "Dasut"
        },
        {
            question: "Which number corresponds to the Korean command \"Yosut\"?",
            options: ["5", "6", "7", "8"],
            answer: "6"
        },
        {
            question: "What is the Korean command for number 6?",
            options: ["Yosut", "Dasut", "Yodul", "Ahop"],
            answer: "Yosut"
        },
        {
            question: "Which number corresponds to the Korean command \"Ilkop\"?",
            options: ["6", "7", "8", "9"],
            answer: "7"
        },
        {
            question: "What is the Korean command for number 7?",
            options: ["Ilkop", "Ahop", "Dasut", "Yodul"],
            answer: "Ilkop"
        },
        {
            question: "Which number corresponds to the Korean command \"Yodul\"?",
            options: ["6", "7", "8", "9"],
            answer: "8"
        },
        {
            question: "What is the Korean command for number 8?",
            options: ["Ahop", "Yodul", "Ilkop", "Dasut"],
            answer: "Yodul"
        },
        {
            question: "Which number corresponds to the Korean command \"Ahop\"?",
            options: ["7", "8", "9", "10"],
            answer: "9"
        },
        {
            question: "What is the Korean command for number 9?",
            options: ["Dasut", "Ahop", "Yosut", "Yul"],
            answer: "Ahop"
        },
        {
            question: "Which number corresponds to the Korean command \"Yul\"?",
            options: ["9", "10", "11", "12"],
            answer: "10"
        },
        {
            question: "What is the Korean command for number 10?",
            options: ["Ahop", "Yul", "Yodul", "Ilkop"],
            answer: "Yul"
        }
    ],
    "9th": [
        {
            question: "What is the meaning of the yellow belt in Taekwondo?",
            options: ["The earth where the plant takes root", "The sun's rays", "The sky where the plant grows towards", "The plant's first sprout"],
            answer: "The sun's rays"
        },
        {
            question: "How do you say \"front kick\" in Korean?",
            options: ["Ap chagi", "Dollyo chagi", "Yop chagi", "Bandae dollyo chagi"],
            answer: "Ap chagi"
        },
        {
            question: "What is the Korean term for \"turning kick\"?",
            options: ["Ap chagi", "Dollyo chagi", "Yop chagi", "Bandae dollyo chagi"],
            answer: "Dollyo chagi"
        },
        {
            question: "In Korean, how do you say \"middle section punch\"?",
            options: ["Eolgul jirugi", "Momtong jirugi", "Arae jirugi", "Yeop jirugi"],
            answer: "Momtong jirugi"
        },
        {
            question: "What is the Korean term for \"horse riding stance\"?",
            options: ["Ap seogi", "Dwit kubi", "Juchum seogi", "Ap kubi"],
            answer: "Juchum seogi"
        },
        {
            question: "What is the Korean term for \"high section block\"?",
            options: ["Arae makki", "Momtong makki", "Olgul makki", "Sonnal makki"],
            answer: "Olgul makki"
        },
        {
            question: "How do you say \"middle inward section block\" in Korean?",
            options: ["Momtong an makki", "Momtong bakkat makki", "Olgul makki", "Arae makki"],
            answer: "Momtong an makki"
        },
        {
            question: "What is the Korean term for \"low section block\"?",
            options: ["Olgul makki", "Momtong makki", "Arae makki", "Sonnal makki"],
            answer: "Arae makki"
        },
        {
            question: "How do you say \"guarding block\" in Korean?",
            options: ["Palmok makki", "Goduro Makki", "Sonnal makki", "Kawi makki"],
            answer: "Goduro Makki"
        },
        {
            question: "Which of the following is NOT a type of block in Taekwondo?",
            options: ["Olgul makki", "Momtong an makki", "Arae makki", "Chagi makki"],
            answer: "Chagi makki"
        }
    ],
    "8th": [
        {
            question: "What does Taegeuk Il Jang represent?",
            options: ["Fire", "Earth", "Water", "Heaven"],
            answer: "Heaven"
        },
        {
            question: "How do you say \"stop\" in Korean?",
            options: ["Shijak", "Geuman", "Kyesok", "Baro"],
            answer: "Geuman"
        },
        {
            question: "What is the Korean term for \"begin\"?",
            options: ["Shijak", "Geuman", "Kyesok", "Baro"],
            answer: "Shijak"
        },
        {
            question: "In Korean, how do you say \"break\"?",
            options: ["Kyeongne", "Kihap", "Kyokpa", "Poomsae"],
            answer: "Kyokpa"
        },
        {
            question: "Which of the following is NOT one of the five tenets of Taekwondo?",
            options: ["Etiquette", "Modesty", "Strength", "Indomitable Spirit"],
            answer: "Strength"
        },
        {
            question: "What is the Korean term for \"double punch\" in Taekwondo?",
            options: ["Jireugi", "Dubeon jireugi", "I-jung jireugi", "Ssang jireugi"],
            answer: "Dubeon jireugi"
        },
        {
            question: "What is the Korean term for 'pushing kick'?",
            options: ["Miro chagi", "Ap chagi", "Yop chagi", "Dwi chagi"],
            answer: "Miro chagi"
        },
        {
            question: "Which kick corresponds to the Korean term 'Miro chagi'?",
            options: ["Front kick", "Pushing kick", "Side kick", "Back kick"],
            answer: "Pushing kick"
        },
        {
            question: "What is the Korean term for 'crescent kick'?",
            options: ["An chagi", "Dollyo chagi", "Naraebang chagi", "Miro chagi"],
            answer: "An chagi"
        },
        {
            question: "Which kick corresponds to the Korean term 'An chagi'?",
            options: ["Front kick", "Crescent kick", "Tornado kick", "Pushing kick"],
            answer: "Crescent kick"
        }
    ],
    "7th": [
        {
            question: "How do you say \"double turning kick\" in Korean?",
            options: ["I-jung dollyo chagi", "Tui chagi", "Bandae dollyo chagi", "Bituro chagi"],
            answer: "I-jung dollyo chagi"
        },
        {
            question: "What is the meaning of the green belt in Taekwondo?",
            options: ["The sun's rays", "The plant's growth", "The sky's vastness", "The earth's stability"],
            answer: "The plant's growth"
        },
        {
            question: "What does Taegeuk Ee Jang represent?",
            options: ["Fire", "Joyfulness", "Water", "Earth"],
            answer: "Joyfulness"
        },
        {
            question: "For which belt level is Taegeuk Ee Jang performed?",
            options: ["7th Kup Green Tags Belt", "6th Kup Green Belt", "5th Kup Blue Tags Belt", "8th Kup Yellow Belt"],
            answer: "6th Kup Green Belt"
        },
        {
            question: "How do you say \"sparring\" in Korean?",
            options: ["Poomsae", "Kyorugi", "Kyokpa", "Hosinsul"],
            answer: "Kyorugi"
        },
        {
            question: "What is the Korean term for \"side kick\" in Taekwondo?",
            options: ["Ap chagi", "Dollyo chagi", "Yop chagi", "Dwit chagi"],
            answer: "Yop chagi"
        },
        {
            question: "How do you say \"stop and return to start\" in Korean Taekwondo commands?",
            options: ["Geuman", "Paro", "Shijakha", "Gyesok"],
            answer: "Paro"
        }
    ],
    "6th": [
        {
            question: "How do you say \"back kick\" in Korean?",
            options: ["Dwit chagi", "Yop chagi", "Dollyo chagi", "Bituro chagi"],
            answer: "Dwit chagi"
        },
        {
            question: "How do you say \"reverse turning kick\" in Korean?",
            options: ["Dollyo chagi", "Bandae dollyo chagi", "Bituro chagi", "Tui chagi"],
            answer: "Bandae dollyo chagi"
        },
        {
            question: "What does Taegeuk Sam Jang represent?",
            options: ["Water", "Earth", "Fire/Sun", "Wind"],
            answer: "Fire/Sun"
        },
        {
            question: "For which belt level is Taegeuk Sam Jang performed?",
            options: ["6th Kup Green Belt", "5th Kup Blue Tags Belt", "4th Kup Blue Belt", "7th Kup Green Tags Belt"],
            answer: "5th Kup Blue Tags Belt"
        },
        {
            question: "What is the Korean term for \"Knife Hand block\" in Taekwondo?",
            options: ["Sonnal makki", "Palmok makki", "Kawi makki", "Batangson makki"],
            answer: "Sonnal makki"
        },
        {
            question: "How do you say \"back fist\" in Korean Taekwondo terminology?",
            options: ["Deungjumeok", "Mejumeok", "Palkup", "Sonnal"],
            answer: "Deungjumeok"
        },
        {
            question: "What is the Korean term for \"back stance\" in Taekwondo?",
            options: ["Ap kubi", "Dwit kubi", "Juchum seogi", "Naranhi seogi"],
            answer: "Dwit kubi"
        },
        {
            question: "How do you say \"Front Stance – long\" in Korean Taekwondo terminology?",
            options: ["Ap seogi", "Ap kubi", "Juchum seogi", "Wen seogi"],
            answer: "Ap kubi"
        },
        {
            question: "What is the Korean term for \"walking stance – short\" in Taekwondo?",
            options: ["Ap seogi", "Dwit kubi", "Juchum seogi", "Naranhi seogi"],
            answer: "Ap seogi"
        }
    ]
};

let allQuestions = [];
let currentQuestionIndex = 0;
let score = 0;
let quizTimerInterval;
let questionTimerInterval;
let quizTime = 60;
let questionTime = 0;
const MAX_POINTS = 100;
let userId = null;
let questionTimes = [1, 2, 3, 4];
let correctAnswers = 0;
let incorrectAnswers = 0;
let userAnswers = [];
let quizAttempts = 0;
let questionsRight = 0;
let questionsWrong = 0;
let averageScore = 0;
let averageTimePerQuestion = 0

document.addEventListener('DOMContentLoaded', function () {
    // Fetch user statistics data
    fetch(`/statistics/data`)
        .then(response => response.json())
        .then(data => {
            console.log("Received data: ", data);
            if (data) {
                // Populate user data from the server response
                userId = data.user.id;
                quizAttempts = data.quizAttempts;
                questionsRight = data.questionsRight;
                questionsWrong = data.questionsWrong;
                averageScore = data.averageScore;
                averageTimePerQuestion = data.averageTimePerQuestion
                console.log("User ID: ", userId);
            } else {
                console.error('No user data available.');
            }
        })
        .catch(error => console.error('Error fetching user data:', error));
    quizAttempts++;

    // Extract belt level from the URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const selectedBelt = urlParams.get('belt');
    const confirmQuitButton = document.getElementById('confirmQuit');

    if (selectedBelt) {
        startQuiz(selectedBelt);
    } else {
        alert("No belt selected. Returning to home page.");
        window.location.href = '/home';
    }

    document.getElementById('quit').addEventListener('click', function () {
        const quitModal = new bootstrap.Modal(document.getElementById('quitModal'));
        quitModal.show();
    });

    if (confirmQuitButton) {
        confirmQuitButton.addEventListener('click', function () {
            quitQuiz();
        });
    } else {
        console.error('confirmQuit button not found in the DOM');
    }

    document.getElementById('next').addEventListener('click', function () {
        const selectedButton = document.querySelector('.quiz-option.selected');
        if (selectedButton) {
            checkAnswer();
        }
    });
});


function startQuiz(belt) {
    console.log('Starting quiz with belt:', belt);  // Debug log
    quizAttempts = quizAttempts + 1;
    loadQuestionsForBelt(belt);
    startQuizTimer();
    loadQuestion();
}

function loadQuestionsForBelt(belt) {
    allQuestions = [];
    const beltLevels = ["10th", "9th", "8th", "7th", "6th"];
    const index = beltLevels.indexOf(belt);
    if (index === -1) {
        console.error("Invalid belt level");
        return;
    }
    // Load questions for the selected belt level and below
    for (let i = 0; i <= index; i++) {
        if (questionsByBelt[beltLevels[i]]) {
            allQuestions = allQuestions.concat(questionsByBelt[beltLevels[i]]);
        }
    }
    shuffleArray(allQuestions);
    currentQuestionIndex = 0;
    score = 0;
    document.getElementById('score').textContent = `Score: 0 / 0`;
}

function loadQuestion() {
    if (currentQuestionIndex >= allQuestions.length) {
        clearInterval(quizTimerInterval);
        endQuiz();
        return;
    }

    const currentQuestion = allQuestions[currentQuestionIndex];
    document.getElementById("question").textContent = currentQuestion.question;
    const optionsContainer = document.getElementById("options");
    optionsContainer.innerHTML = '';
    currentQuestion.options.forEach(option => {
        const optionElement = document.createElement("button");
        optionElement.textContent = option;
        optionElement.classList.add("btn", "btn-outline-primary", "m-2", "quiz-option");
        //changed () to (event)
        optionElement.onclick = (event) => selectAnswer(event, option);
        optionsContainer.appendChild(optionElement);
    });
    document.getElementById('next').disabled = true;

    startQuestionTimer();
}

function selectAnswer(event, selectedOption) {
    document.querySelectorAll('.quiz-option').forEach(btn => {
        btn.classList.remove('selected');
    });
    event.target.classList.add('selected');
    document.getElementById('next').disabled = false;

    // Store the user's answer
    userAnswers[currentQuestionIndex] = selectedOption;
}

function checkAnswer() {
    const selectedButton = document.querySelector('.quiz-option.selected');
    if (!selectedButton) return;

    const selectedOption = selectedButton.textContent;
    const currentQuestion = allQuestions[currentQuestionIndex];
    const isCorrect = selectedOption === currentQuestion.answer;

    // Update correct/incorrect counters
    if (isCorrect) {
        correctAnswers++;
        score += calculatePoints();
    } else {
        incorrectAnswers++;
    }

    // Store the time taken for the current question
    questionTimes.push(questionTime);
    currentQuestionIndex++;
    document.getElementById('score').textContent = `Score: ${score} / ${currentQuestionIndex * MAX_POINTS}`;
    loadQuestion();
}

function calculatePoints() {
    if (questionTime <= 3) {
        return MAX_POINTS;
    } else if (questionTime <= 5) {
        return 70;
    } else if (questionTime <= 7) {
        return 40;
    } else {
        return 20;
    }
}

function startQuizTimer() {
    const quizTimerElement = document.getElementById('quiz-timer');
    if (!quizTimerElement) {
        console.error('Quiz timer element not found');
        return;
    }
    console.log('Starting quiz timer');  // Debug log
    quizTime = 60;
    quizTimerElement.textContent = `Quiz Time: ${quizTime}`;
    quizTimerInterval = setInterval(function () {
        quizTime--;
        quizTimerElement.textContent = `Quiz Time: ${quizTime}`;
        console.log(`Quiz Time: ${quizTime}`);
        if (quizTime <= 0) {
            clearInterval(quizTimerInterval);
            endQuiz();
        }
    }, 1000);
}

function startQuestionTimer() {
    if (questionTimerInterval) {
        clearInterval(questionTimerInterval);
    }
    questionTime = 0;
    questionTimerInterval = setInterval(function () {
        questionTime++;
        console.log(`Question Time: ${questionTime}`);  // Debug log
    }, 1000);
}


function calculateQuestionsRight(existingQuestionsRight, correctAnswers) {
    return existingQuestionsRight + correctAnswers;
}

function calculateQuestionsWrong(existingQuestionsWrong, incorrectAnswers) {
    return existingQuestionsWrong + incorrectAnswers;
}

function calculateAverageScore(existingTotalQuestions, existingAverageScore, correctAnswers, incorrectAnswers) {
    const totalQuestions = existingTotalQuestions + correctAnswers + incorrectAnswers;
    const totalCorrectAnswers = (existingAverageScore * existingTotalQuestions / 100) + correctAnswers;
    return totalQuestions > 0 ? (totalCorrectAnswers / totalQuestions) * 100 : 0;
}


function calculateAverageTimePerQuestion(totalQuestions, totalTime) {
    return totalQuestions > 0 ? totalTime / totalQuestions : 0;
}


// Function to fetch and update the statistics
async function updateStatistics(userId, correctAnswers, incorrectAnswers, questionTimes) {
    let questionTimes_tmp = questionTimes;
    let updatedQuestionsRight = calculateQuestionsRight(questionsRight, correctAnswers);
    let updatedQuestionsWrong = calculateQuestionsWrong(questionsWrong, incorrectAnswers);
    let updatedAverageScore = calculateAverageScore(
        quizAttempts * (questionsRight + questionsWrong),
        averageScore,
        correctAnswers,
        incorrectAnswers
    );
    let existingTotalQuestions = quizAttempts * (questionsRight + questionsWrong);
    let totalQuestions = existingTotalQuestions + questionTimes.length;
    let totalTime = (averageTimePerQuestion * existingTotalQuestions) + questionTimes.reduce((acc, time) => acc + time, 0);
    console.log("quizATEMPTS" + quizAttempts);

    let updatedAverageTimePerQuestion = totalQuestions > 0 ? totalTime / totalQuestions : 0;

    // Save updated statistics back to the database
    saveUpdatedStatistics(userId, quizAttempts, updatedQuestionsRight, updatedQuestionsWrong, updatedAverageScore, updatedAverageTimePerQuestion);

    return {
        quizAttempts: quizAttempts,
        questionsRight: updatedQuestionsRight,
        questionsWrong: updatedQuestionsWrong,
        averageScore: updatedAverageScore,
        averageTimePerQuestion: updatedAverageTimePerQuestion
    };
}

function saveUpdatedStatistics(userId, quizAttempts, questionsRight, questionsWrong, averageScore, averageTimePerQuestion) {
    fetch(`/statistics/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            user: {id: userId},
            quizAttempts,
            questionsRight,
            questionsWrong,
            averageScore,
            averageTimePerQuestion
        })
    })
        .then(response => response.json())
        .then(data => {
            console.log("Updated statistics saved:", data);
        })
        .catch(error => console.error('Error saving updated statistics:', error));
}

function endQuiz() {
    clearInterval(quizTimerInterval);
    clearInterval(questionTimerInterval);

    // Calculate and update statistics
    updateStatistics(userId, correctAnswers, incorrectAnswers, questionTimes)
        .then((updatedStats) => {
            const quizContainer = document.getElementById("quiz-container");
            quizContainer.innerHTML = `
                <h2>Time's up! Quiz finished!</h2>
                <button id="try-again-btn" class="btn btn-success m-2">Try Again</button>
                <button id="quit-btn" class="btn btn-secondary m-2">Quit</button>
            `;

            const tryAgainBtn = document.getElementById('try-again-btn');
            const quitBtn = document.getElementById('quit-btn');

            if (tryAgainBtn) {
                tryAgainBtn.addEventListener('click', function () {
                    restartQuiz();
                });
            } else {
                console.error('try-again-btn not found in the DOM');
            }

            if (quitBtn) {
                quitBtn.addEventListener('click', function () {
                    quitQuiz();
                });
            } else {
                console.error('quit-btn not found in the DOM');
            }
        })
        .catch(error => console.error('Error updating statistics:', error));

    questionsRight = 0;
    questionsWrong = 0;
    averageScore = 0;
    averageTimePerQuestion = 0;
}

function restartQuiz() {
    submitQuizResults(userId, quizAttempts, calculateQuestionsRight(), calculateQuestionsWrong(), calculateAverageScore(), calculateAverageTimePerQuestion(), new Date().toISOString().split('T')[0]);

    window.location.reload();
}

function quitQuiz() {
    submitQuizResults(userId, quizAttempts, calculateQuestionsRight(), calculateQuestionsWrong(), calculateAverageScore(), calculateAverageTimePerQuestion(), new Date().toISOString().split('T')[0]);

    clearInterval(quizTimerInterval);
    clearInterval(questionTimerInterval);

    window.location.href = '/home';
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}
